<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> NETGEAR WNDR4300 折腾之 OpenWrt + dnsmasq + SS · Leyar's Notebook</title><meta name="description" content="NETGEAR WNDR4300 折腾之 OpenWrt + dnsmasq + SS - Leyar"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.leyar.me/atom.xml" title="Leyar's Notebook"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/iLeyar" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">NETGEAR WNDR4300 折腾之 OpenWrt + dnsmasq + SS</h1><div class="post-info">2015年8月1日</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一直想入手一个可以刷 <a href="http://wiki.openwrt.org/toh/netgear/wndr4300" target="_blank" rel="external">OpenWrt</a> 的路由器，国内的不考虑，国外的看中了两款，NETGEAR 的 WNDR4300 以及 linksys 的 E4200，E4200 貌似不能刷 OpenWrt，而且国内也没有地方可以买到。于是 WNDR4300 成了不二之选。</p>
<p>这里记录下我的刷机并且实现自动科学上网的过程.</p>
<blockquote>
<p>本机系统环境： Archlinux<br><a href="https://sourceforge.net/p/openwrt-dist/wiki/DNS/" target="_blank" rel="external">防 DNS 劫持</a>方案: dnsmasq 搭配 ss-tunnel<br>针对 IP 封锁：搭配 ignore.list 列表<br><a id="more"></a></p>
</blockquote>
<h2 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a>刷机</h2><h3 id="下载-OpenWrt-固件"><a href="#下载-OpenWrt-固件" class="headerlink" title="下载 OpenWrt 固件"></a>下载 OpenWrt 固件</h3><p>下载 OpenWrt 官方安装镜像及升级包，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/nand/openwrt-ar71xx-nand-wndr4300-ubi-factory.img</div><div class="line">wget http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/nand/openwrt-ar71xx-nand-wndr4300-squashfs-sysupgrade.tar</div></pre></td></tr></table></figure>
<h3 id="刷入-OpenWrt-固件"><a href="#刷入-OpenWrt-固件" class="headerlink" title="刷入 OpenWrt 固件"></a>刷入 OpenWrt 固件</h3><p>登录路由器管理界面 (<a href="http://www.routerlogin.net" target="_blank" rel="external">http://www.routerlogin.net</a>) 进入「固件升级」页面，选择下载的安装镜像<code>openwrt-ar71xx-nand-wndr4300-ubi-factory.img</code>，点「确定」。</p>
<p>等待镜像刷入成功。</p>
<p>初次登入 OpenWrt 是没有密码的，随机键入一个字符即可进入管理界面。</p>
<h3 id="升级-OpenWrt-固件"><a href="#升级-OpenWrt-固件" class="headerlink" title="升级 OpenWrt 固件"></a>升级 OpenWrt 固件</h3><p>「System」-「Backup/Flash Firmware」-「Flash new firmware image」，选中下载的<code>openwrt-ar71xx-nand-wndr4300-squashfs-sysupgrade.tar</code>升级包，「Flash image…」</p>
<p>等待升级成功。</p>
<h3 id="重启路由"><a href="#重启路由" class="headerlink" title="重启路由"></a>重启路由</h3><p>当固件刷入成功后，为了确保 5GHz 的 WiFi 功能能正常使用，必须先关闭路由电源等待 5s 再开启电源重新启动。</p>
<p>至此，刷机步骤完成。</p>
<h2 id="配置-OpenWrt"><a href="#配置-OpenWrt" class="headerlink" title="配置 OpenWrt"></a>配置 OpenWrt</h2><h3 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h3><p>「Network」-「Interface」-<code>WAN</code>后面的「Edit」，<code>Protocol</code>选择<code>PPPoE</code>，「Switch Protocol」，输入帐号密码，「Save&amp;Apply」，配置正确的话，此时有线网络可以正常连接上。</p>
<h3 id="更改界面语言"><a href="#更改界面语言" class="headerlink" title="更改界面语言"></a>更改界面语言</h3><p><em>PS: 此步骤可选，我为了尽量节省空间，就没有做修改.</em></p>
<p>「System」-「Software」-「Update list」-<code>filter</code>后面输入<code>chinese</code>搜索语言包，切换到「Available Packages」，点击搜索到的软件包后面的「install」安装中文包。</p>
<p>「System」-「System」-「Language&amp;style」选择<code>chinese</code>-「Save&amp;Apply」，刷新即可甚至界面为中文。</p>
<h2 id="安装及配置-Dnsmasq-和-SS"><a href="#安装及配置-Dnsmasq-和-SS" class="headerlink" title="安装及配置 Dnsmasq 和 SS"></a>安装及配置 Dnsmasq 和 SS</h2><blockquote>
<p>这里罗列一下使用到的开源项目包括版本(截至2015-11-9)：</p>
<ul>
<li><a href="https://github.com/shadowsocks/openwrt-shadowsocks" target="_blank" rel="external">shadowsocks-libev-spec</a> v2.4.1-1 </li>
<li><a href="https://github.com/aa65535/openwrt-dnsmasq" target="_blank" rel="external">dnsmasq-full</a> v2.72-4</li>
</ul>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><code>ssh</code> 到 openwrt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh root@192.168.1.1</div></pre></td></tr></table></figure>
<p>更新软件包列表并安装依赖包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">opkg update</div><div class="line">opkg install ip libc libgcc libgmp libnettle libopenssl zlib</div></pre></td></tr></table></figure>
<p>添加第三方源<code>OpenWrt-dist</code>源到<code>etc/opkg.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'src/gz openwrt_dist http://openwrt-dist.sourceforge.net/releases/ar71xx/packages</span></div><div class="line">src/gz openwrt_dist_luci http://openwrt-dist.sourceforge.net/releases/luci/packages' &gt;&gt; /etc/opkg.conf</div></pre></td></tr></table></figure>
<p>卸载原本自带的 dnsmasq，安装 dnsmasq-full 和 spec 版 ss </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">opkg update</div><div class="line">opkg remove dnsmasq</div><div class="line">opkg install dnsmasq-full</div><div class="line">opkg install shadowsocks-libev-spec</div><div class="line">opkg install luci-app-shadowsocks-spec</div></pre></td></tr></table></figure>
<blockquote>
<p>有时候会发现安装速度很慢，此时也可通过 PC 端下载并传至路由器 <code>/tmp</code>目录再执行安装．<br>上传文件到路由器：<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp luci-app-shadowsocks-spec_1.3.3-1_all.ipk shadowsocks-libev-spec_2.2.3-1_ar71xx.ipk root@192.168.1.1:/tmp/</div></pre></td></tr></table></figure></p>
<p>ssh 到路由器执行安装:<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /tmp</div><div class="line">opkg install shadowsocks-libev-spec_2.2.3-1_ar71xx.ipk</div><div class="line">opkg install luci-app-shadowsocks-spec_1.3.3-1_all.ipk</div></pre></td></tr></table></figure></p>
</blockquote>
<p>下载忽略列表文件到<code>/etc/shadowsocks/ignore.list</code>，之后更新该文件也是使用此命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -O- <span class="string">'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'</span> | awk -F\| <span class="string">'/CN\|ipv4/ &#123; printf("%s/%d\n", $4, 32-log($5)/log(2)) &#125;'</span> &gt; /etc/shadowsocks/ignore.list</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="SS-的配置"><a href="#SS-的配置" class="headerlink" title="SS 的配置"></a>SS 的配置</h4><p>登录到路由器的 WEB 管理界面，</p>
<p>「Services」-「ShadowSocks」- 「Global Setting」 里 「Enable」打勾并在下面输入 ss 服务器信息，「Proxy Setting」下的 「Proxy Method」选择<code>Ignore List</code>，「Proxy Protocol」选择<code>TCP only</code>，「UDP Forward」下勾选 「Enable」，然后点击「Save &amp; Apply」即可．</p>
<p>这里配置启用了UDP 端口转发，默认会把本地的 5300 端口内容转发到 <code>8.8.4.4#53</code>．</p>
<h4 id="DNS-的配置"><a href="#DNS-的配置" class="headerlink" title="DNS 的配置"></a>DNS 的配置</h4><p>「Network」-「DHCP and DNS」-「Resolv and Hosts Files」- 勾选「Ignore Hosts files」防止上级 DNS 的污染.</p>
<p>打开 SSH 窗口，在<code>/etc/dnsmasq.conf</code>中加入如下内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server=127.0.0.1#5300</div></pre></td></tr></table></figure>
<p>通过如上配置，可以有效防止DNS污染，使所有的网址都通过 GOOGLE 公共DNS 服务器来解析，但同时会使某些情况下访问国内网站会出现国际版的情况，此时就需要进行针对性的优化了．</p>
<p>基本思路是，国内的站点使用 114 来进行解析，国外的站点继续走 GOOGLE 的公共 DNS．这可以通过对 dnsmasq 进行配置来实现．</p>
<blockquote>
<p>相关的配置文件如下:<br>[dnsmasq.conf] (<a href="https://github.com/aa65535/openwrt-dnsmasq/tree/master/etc" target="_blank" rel="external">https://github.com/aa65535/openwrt-dnsmasq/tree/master/etc</a>)<br>[dnsmasq-china-list] (<a href="https://github.com/felixonmars/dnsmasq-china-list" target="_blank" rel="external">https://github.com/felixonmars/dnsmasq-china-list</a>)</p>
</blockquote>
<p>操作步骤:</p>
<p>SSH 到openwrt</p>
<p>修改 <code>/etc/dnsmasq.conf</code> 文件，对应的配置范例可点击上面链接，主要修改的几个地方:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">no-poll</div><div class="line">no-resolv</div><div class="line">all-servers</div><div class="line"></div><div class="line">server=127.0.0.1#5300</div><div class="line">conf-dir=/etc/dnsmasq.d</div></pre></td></tr></table></figure>
<p>创建 <code>dnsmasq.d</code> 配置目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir /etc/dnsmasq.d</div></pre></td></tr></table></figure>
<p>切换到 PC 端 terminal 操作(Linux 系统下)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> ~/Download</div><div class="line">$ mkdir dnsmasq.d</div><div class="line">$ <span class="built_in">cd</span> dnsmasq.d</div><div class="line">$ git <span class="built_in">clone</span> git://github.com/felixonmars/dnsmasq-china-list .</div><div class="line">$ scp accelerated-domains.china.conf google.china.conf root@192.168.1.1:/etc/dnsmasq.d/		<span class="comment"># 这里将国内网址列表这个文件上传到路由器.</span></div></pre></td></tr></table></figure></p>
<h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/shadowsocks restart</div><div class="line">/etc/init.d/dnsmasq restart</div></pre></td></tr></table></figure>
<p>此时可以测试操作是否成功了。测试相关 ip 网址如下:</p>
<ul>
<li>国内 <a href="http://ip.cn" target="_blank" rel="external">http://ip.cn</a></li>
<li>国外 <a href="http://www.whatsmyip.org/" target="_blank" rel="external">http://www.whatsmyip.org/</a></li>
<li>查询所使用的 DNS 服务 <a href="https://www.whatsmydns.net/" target="_blank" rel="external">https://www.whatsmydns.net/</a></li>
</ul>
<h2 id="添加计划任务实现自动更新"><a href="#添加计划任务实现自动更新" class="headerlink" title="添加计划任务实现自动更新"></a>添加计划任务实现自动更新</h2><p>备注: 此更新脚本可以自动更新已安装的软件脚本以及 <code>ignore list</code>文件. 关于国内网址列表文件，我是在本机客户端自做了一个小脚本自动更新 git 仓库并上传到路由器覆盖.</p>
<p>ssh 到 openwrt，新建文件 <code>/root/update</code>，添加如下内容:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line"><span class="comment"># 更新 ignore 文件</span></div><div class="line"></div><div class="line"><span class="built_in">set</span> <span class="_">-e</span> -o pipefail</div><div class="line"></div><div class="line">wget -O- <span class="string">'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'</span> | \</div><div class="line">    awk -F\| <span class="string">'/CN\|ipv4/ &#123; printf("%s/%d\n", $4, 32-log($5)/log(2)) &#125;'</span> &gt; \ </div><div class="line">    /tmp/ignore.list</div><div class="line"></div><div class="line">mv /tmp/ignore.list /etc/shadowsocks/</div><div class="line"></div><div class="line"><span class="keyword">if</span> pidof ss-redir&gt;/dev/null; <span class="keyword">then</span></div><div class="line">    /etc/init.d/shadowsocks rules</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># 更新软件</span></div><div class="line"></div><div class="line">opkg update</div><div class="line"></div><div class="line"><span class="keyword">for</span> ipk <span class="keyword">in</span> $(opkg list-upgradable | awk <span class="string">'$1!~/^kmod|^Multiple/&#123;print $1&#125;'</span>); <span class="keyword">do</span></div><div class="line">    opkg upgrade <span class="variable">$ipk</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>运行命令 <code>chmod +x /root/update</code> 给脚本添加可执行权限</p>
<p>打开路由器 WEB 管理界面:</p>
<p>「System」-「Scheduled Tasks」填写如下内容(每天 04:30 执行):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">30    4     *     *     *     /root/update&gt;/dev/null 2&gt;&amp;1</div></pre></td></tr></table></figure>
<h2 id="后续补充"><a href="#后续补充" class="headerlink" title="后续补充"></a>后续补充</h2><p>还有一些涉及到的例如 SS 服务器的安装与优化，及其他的一些改善内容，后续再慢慢研究。</p>
<blockquote>
<p>参考资料:</p>
<ul>
<li><a href="http://undownding.me/2015/02/10/use-shadowsocks-on-openwrt/" target="_blank" rel="external">Use Shadowsocks on OpenWrt</a></li>
</ul>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/install-the-shadowsocks/" class="prev">上一篇</a><a href="/setting-up-dns-server-on-centos7/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ileyar';
var disqus_identifier = 'netgear-wndr4300-openwrt-shadowsocks/';
var disqus_title = 'NETGEAR WNDR4300 折腾之 OpenWrt + dnsmasq + SS';
var disqus_url = 'http://www.leyar.me/netgear-wndr4300-openwrt-shadowsocks/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ileyar.disqus.com/count.js" async></script><div class="copyright"><p>© 2011 - 2018 <a href="http://www.leyar.me">Leyar</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-74627504-2",'auto');ga('send','pageview');</script></body></html>