<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Shadowsocks 之优化篇 · Leyar's Notebook</title><meta name="description" content="Shadowsocks 之优化篇 - Leyar"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.leyar.me/atom.xml" title="Leyar's Notebook"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/iLeyar" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Shadowsocks 之优化篇</h1><div class="post-info">2015年8月1日</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>优化 Shadowsocks server 的前提条件是内核版本在 3.5 以上，可通过<code>uname -ir</code>查看当前内核版本，如果版本过低，需要升级。</p>
<p>以下我的 VPS 内核版本升级的简单步骤：</p>
<blockquote>
<p>   VPS ： Digitalocean and Linode<br>   系统版本： CentOS 7 64bit<br><a id="more"></a></p>
</blockquote>
<h2 id="更新内核"><a href="#更新内核" class="headerlink" title="更新内核"></a>更新内核</h2><p>查看当前内核版本信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">uname -ir</div><div class="line">3.10.0-123.8.1.el7.x86_64 x86_64</div></pre></td></tr></table></figure>
<p>Digitalocean 关于 Kernels 的更新操作可参考<a href="https://www.digitalocean.com/community/tutorials/how-to-update-a-digitalocean-server-s-kernel" target="_blank" rel="external">这里</a></p>
<p>更新并安装最新版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">yum update</div><div class="line">yum list --showduplicates kernel	<span class="comment"># 列出可用的 kernel 版本</span></div><div class="line">--------------------------------</div><div class="line">yum install kernel-*(3.10.0-229.el7)*		<span class="comment"># 安装所需版本</span></div></pre></td></tr></table></figure>
<p>验证安装及列出服务器上所有已安装的 kernels：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /boot</div><div class="line">ls vmlinuz*</div></pre></td></tr></table></figure>
<p>记住版本信息,进入 <a href="https://www.digitalocean.com/community/tutorials/how-to-update-a-digitalocean-server-s-kernel-using-the-control-panel#changing-the-kernel-in-the-digitalocean-control-panel" target="_blank" rel="external">Digitalocean 控制面板</a> ,修改想要使用的内核版本。</p>
<p>Poweroff then poweron.</p>
<h2 id="Optimize-the-shadowsocks-server"><a href="#Optimize-the-shadowsocks-server" class="headerlink" title="Optimize the shadowsocks server"></a><a href="http://shadowsocks.org/en/config/advanced.html" target="_blank" rel="external">Optimize the shadowsocks server</a></h2><p>增加 TCP 连接数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'* soft nofile 51200</span></div><div class="line">* hard nofile 51200' &gt;&gt; /etc/security/limits.conf</div></pre></td></tr></table></figure>
<p>编辑 <code>/etc/sysctl.conf</code> 文件，优化 TCP 参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>加入以下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"># max open files</div><div class="line">fs.file-max = 51200</div><div class="line"># max read buffer</div><div class="line">net.core.rmem_max = 67108864</div><div class="line"># max write buffer</div><div class="line">net.core.wmem_max = 67108864</div><div class="line"># default read buffer</div><div class="line">net.core.rmem_default = 65536</div><div class="line"># default write buffer</div><div class="line">net.core.wmem_default = 65536</div><div class="line"># max processor input queue</div><div class="line">net.core.netdev_max_backlog = 4096</div><div class="line"># max backlog</div><div class="line">net.core.somaxconn = 4096</div><div class="line"></div><div class="line"># resist SYN flood attacks</div><div class="line">net.ipv4.tcp_syncookies = 1</div><div class="line"># reuse timewait sockets when safe</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line"># turn off fast timewait sockets recycling</div><div class="line">net.ipv4.tcp_tw_recycle = 0</div><div class="line"># short FIN timeout</div><div class="line">net.ipv4.tcp_fin_timeout = 30</div><div class="line"># short keepalive time</div><div class="line">net.ipv4.tcp_keepalive_time = 1200</div><div class="line"># outbound port range</div><div class="line">net.ipv4.ip_local_port_range = 10000 65000</div><div class="line"># max SYN backlog</div><div class="line">net.ipv4.tcp_max_syn_backlog = 4096</div><div class="line"># max timewait sockets held by system simultaneously</div><div class="line">net.ipv4.tcp_max_tw_buckets = 5000</div><div class="line"># turn on TCP Fast Open on both client and server side</div><div class="line">net.ipv4.tcp_fastopen = 3</div><div class="line"># TCP receive buffer</div><div class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</div><div class="line"># TCP write buffer</div><div class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</div><div class="line"># turn on path MTU discovery</div><div class="line">net.ipv4.tcp_mtu_probing = 1</div></pre></td></tr></table></figure></p>
<p>刷新配置文件使之生效：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl --system</div></pre></td></tr></table></figure></p>
<p>修改服务器中 shadowsocks 的 json 文件以开启 fast open:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fast_open: true</div></pre></td></tr></table></figure>
<p>SSH 到路由器，进行如下操作:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> 3 &gt; /proc/sys/net/ipv4/tcp_fastopen</div></pre></td></tr></table></figure>
<p>参考链接：</p>
<ul>
<li><a href="https://shadowsocks.org/en/config/advanced.html" target="_blank" rel="external">Optimize the shadowsocks server on Linux</a></li>
<li><a href="https://github.com/shadowsocks/shadowsocks/wiki/Optimizing-Shadowsocks" target="_blank" rel="external">Optimizing Shadowsocks</a></li>
<li><a href="https://github.com/shadowsocks/shadowsocks/wiki/TCP-Fast-Open" target="_blank" rel="external">TCP Fast Open</a></li>
<li><a href="https://www.ifshow.com/centos-7-shadowsocks-optimization/" target="_blank" rel="external">CentOS 7 Shadowsocks 优化</a></li>
</ul>
<hr>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新　"></a>更新　</h2><p>2016-1-12: 不要启用 <code>net.ipv4.tcp_tw_reuse</code> ,上文的配置文件已修正．具体原因可参考:</p>
<ul>
<li><a href="http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html" target="_blank" rel="external">Coping with the TCP TIME-WAIT state on busy Linux servers</a></li>
<li><a href="http://www.cnxct.com/coping-with-the-tcp-time_wait-state-on-busy-linux-servers-in-chinese-and-dont-enable-tcp_tw_recycle/" target="_blank" rel="external">不要在linux上启用net.ipv4.tcp_tw_recycle参数</a></li>
</ul>
<p>2017-2-14: 修改<code>sysctl.conf</code>配置文件</p>
<h2 id="编译并启用-hybla-模块"><a href="#编译并启用-hybla-模块" class="headerlink" title="编译并启用 hybla 模块"></a>编译并启用 hybla 模块</h2><p>检查系统可用算法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl net.ipv4.tcp_available_congestion_control</div></pre></td></tr></table></figure></p>
<p>Linode 没有自带，所以需要编译</p>
<h3 id="检查-vps-内核版本"><a href="#检查-vps-内核版本" class="headerlink" title="检查 vps 内核版本"></a>检查 vps 内核版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">uname -r</div><div class="line">4.8.6-x86_64-linode78</div></pre></td></tr></table></figure>
<h3 id="下载对应版本的内核源码"><a href="#下载对应版本的内核源码" class="headerlink" title="下载对应版本的内核源码"></a>下载对应版本的内核源码</h3><p>到<a href="https://www.kernel.org/pub/linux/kernel/v4.x/" target="_blank" rel="external">https://www.kernel.org/pub/linux/kernel/v4.x/</a> 查找并下载对应版本的tar.gz 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir /root/kernel</div><div class="line"><span class="built_in">cd</span> /root/kernel</div><div class="line">wget https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.8.6.tar.gz</div><div class="line">tar xvf linux-4.8.6.tar.gz</div></pre></td></tr></table></figure></p>
<h3 id="安装编译工具"><a href="#安装编译工具" class="headerlink" title="安装编译工具"></a>安装编译工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y groupinstall <span class="string">"Development Tools"</span></div><div class="line">yum -y install ncurses-devel ncurses</div></pre></td></tr></table></figure>
<h3 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> linux-4.8.6</div><div class="line">zcat /proc/config.gz &gt; .config</div><div class="line">vi .config</div></pre></td></tr></table></figure>
<p>查找<code>CONFIG_TCP_CONG_CUBIC=y</code>,在其下面增加一行<code>CONFIG_TCP_CONG_HYBLA=y</code><br>开始编译<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make</div></pre></td></tr></table></figure></p>
<p>等待内核编译完成，单核编译约15分钟。</p>
<h3 id="编译模块"><a href="#编译模块" class="headerlink" title="编译模块"></a>编译模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> net/ipv4/</div><div class="line">mv Makefile Makefile.old</div><div class="line">vi Makefile</div></pre></td></tr></table></figure>
<p>加入以下内容，<code>KDIR</code> 后面修改为你的源码路径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Makefile for tcp_hybla.ko</div><div class="line">obj-m := tcp_hybla.o</div><div class="line">KDIR := /root/kernel/linux-4.8.6</div><div class="line">PWD := $(shell pwd)</div><div class="line">default:</div><div class="line">	$(MAKE) -C $(KDIR) SUBDIRS=$(PWD) modules</div></pre></td></tr></table></figure></p>
<p>进入源码根目录，开始编译模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /root/kernel/linux-4.8.6/</div><div class="line">make modules</div></pre></td></tr></table></figure></p>
<p>等待编译完成。</p>
<h3 id="测试加载模块"><a href="#测试加载模块" class="headerlink" title="测试加载模块"></a>测试加载模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /root/kernel/linux-4.8.6/net/ipv4</div><div class="line">cp tcp_hybla.ko /root/kernel/</div><div class="line"><span class="built_in">cd</span> /root/kernel</div><div class="line">insmod tcp_hybla.ko</div></pre></td></tr></table></figure>
<p>如果加载成功，则执行命令显示如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sysctl net.ipv4.tcp_available_congestion_control</div><div class="line">net.ipv4.tcp_available_congestion_control = cubic reno hybla		<span class="comment"># 输出结果后面多了一个 hybla</span></div></pre></td></tr></table></figure></p>
<h3 id="设置开机自动加载模块"><a href="#设置开机自动加载模块" class="headerlink" title="设置开机自动加载模块"></a>设置开机自动加载模块</h3><p>将<code>tcp_hybla.ko</code> 拷贝到 <code>/lib/modules/4.8.6-x86_64-linode78/kernel/net/ipv4</code>目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /lib/modules/4.8.6-x86_64-linode78/</div><div class="line">mkdir -p kernel/net/ipv4</div><div class="line"><span class="built_in">cd</span> kernel/net/ipv4</div><div class="line">cp /root/kernel/tcp_hybla.ko .</div><div class="line"><span class="built_in">cd</span> /lib/modules/4.8.6-x86_64-linode78/</div><div class="line">depmod <span class="_">-a</span></div></pre></td></tr></table></figure></p>
<p>如果出现如下文件不存在的警告，可以通过创建对应的空白文件来解决。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">depmod: WARNING: could not open /lib/modules/4.8.6-x86_64-linode78/modules.order: No such file or directory</div><div class="line">depmod: WARNING: could not open /lib/modules/4.8.6-x86_64-linode78/modules.builtin: No such file or directory</div></pre></td></tr></table></figure></p>
<p>解决办法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">touch modules.order</div><div class="line">touch modules.builtin</div></pre></td></tr></table></figure></p>
<p>再重新执行<code>depmod -a</code>命令即可。</p>
<h3 id="设置-hybla-优先加载"><a href="#设置-hybla-优先加载" class="headerlink" title="设置 hybla 优先加载"></a>设置 hybla 优先加载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>加入以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># for high-latency network</div><div class="line">net.ipv4.tcp_congestion_control=hybla</div></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/resolve-the-issue-about-Permission-denied/" class="prev">上一篇</a><a href="/install-the-shadowsocks/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ileyar';
var disqus_identifier = 'optimize-the-shadowsocks/';
var disqus_title = 'Shadowsocks 之优化篇';
var disqus_url = 'http://www.leyar.me/optimize-the-shadowsocks/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ileyar.disqus.com/count.js" async></script><div class="copyright"><p>© 2011 - 2018 <a href="http://www.leyar.me">Leyar</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-74627504-2",'auto');ga('send','pageview');</script></body></html>