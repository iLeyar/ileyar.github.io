<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> VPS 安全设置 · Leyar's Notebook</title><meta name="description" content="VPS 安全设置 - Leyar"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.leyar.me/atom.xml" title="Leyar's Notebook"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/iLeyar" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">VPS 安全设置</h1><div class="post-info">2015年6月10日</div><div class="post-content"><p>当给一台 VPS 安装好系统之后，最首要的任务，就是进行一些安全设置了。这里记录一下我的操作过程。</p>
<blockquote>
<p>这里 VPS 系统以 Debian7.0 32位为例子，正常情况下，Debian/Ubuntu 系统适用。</p>
</blockquote>
<p>大致要设置的内容如下：</p>
<ul>
<li>添加一个新用户</li>
<li>使用 SSH Key 密钥登陆</li>
<li>修改 SSH 端口，禁止 SSH 密码验证和 Root 登陆</li>
<li>创建防火墙</li>
<li>安装配置 Fail2Ban</li>
</ul>
<a id="more"></a>
<p>下面说下具体的实现步骤。</p>
<h2 id="添加新用户"><a href="#添加新用户" class="headerlink" title="添加新用户"></a>添加新用户</h2><p>首先使用 SSH 登陆 vps</p>
<p>添加用户, leyar 改为其他想要设置的用户名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adduser leyar</div></pre></td></tr></table></figure></p>
<p>添加用户到系统管理员组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usermod <span class="_">-a</span> -G sudo leyar</div></pre></td></tr></table></figure></p>
<p>退出 root 用户登陆<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">logout</span></div></pre></td></tr></table></figure></p>
<p>使用新用户登陆 Vps<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ssh leyar@162.254.0.100</div><div class="line">leyar@162.254.0.100<span class="string">'s password:                  #这里输入新用户密码</span></div></pre></td></tr></table></figure></p>
<h2 id="使用-SSH-Key-密钥"><a href="#使用-SSH-Key-密钥" class="headerlink" title="使用 SSH Key 密钥"></a>使用 SSH Key 密钥</h2><p>首先在<strong>本机系统</strong>（我的是 Ubuntu系统）生成 SSH keys<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ssh-keygen</div></pre></td></tr></table></figure></p>
<p>默认情况下会在本机 <code>~/.ssh/</code>目录下产生两个文件<code>id_rsa</code>和<code>id_rsa.pub</code>，我这里因生成的过程中修改了文件名为<code>witlayer_rsa</code>，因此我的公钥为<code>witlayer_rsa.pub</code></p>
<p>从本机上传公钥到服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ scp ~/.ssh/witlayer_rsa.pub leyar@162.254.0.100:</div></pre></td></tr></table></figure></p>
<p>在 Vps 服务器的<code>/home/leyar</code>目录下创建<code>.ssh</code>文件夹，并将上传的文件移动到该目录下并重命名为<code>authorized_keys</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir .ssh</div><div class="line">mv witlayer_rsa.pub .ssh/authorized_keys</div></pre></td></tr></table></figure></p>
<p>给<code>authorized_keys</code>文件设置权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chown -R leyar:leyar .ssh</div><div class="line">chmod 700 .ssh</div><div class="line">chmod 600 .ssh/authorized_keys</div></pre></td></tr></table></figure></p>
<p>到此，SSH Key 设置完毕。</p>
<h2 id="修改端口-禁止-SSH-密码登陆及-Root-登陆。"><a href="#修改端口-禁止-SSH-密码登陆及-Root-登陆。" class="headerlink" title="修改端口,禁止 SSH 密码登陆及 Root 登陆。"></a>修改端口,禁止 SSH 密码登陆及 Root 登陆。</h2><p>打开配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo vi /etc/ssh/sshd_config</div></pre></td></tr></table></figure></p>
<p>修改配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Port 1688</div><div class="line"></div><div class="line">PermitRootLogin no</div><div class="line"></div><div class="line">PasswordAuthentication no</div></pre></td></tr></table></figure></p>
<p>重启 SSH 服务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo service ssh restart</div></pre></td></tr></table></figure></p>
<p>如果出现如下错误：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Could not load host key: /etc/ssh/ssh_host_ecdsa_key</div><div class="line">[....] Restarting OpenBSD Secure Shell server: sshdCould not load host key: /etc/ssh/ssh_host_ecdsa_key</div><div class="line">. ok</div></pre></td></tr></table></figure></p>
<p>此时通过执行重新生成 hosts keys 操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo rm /etc/ssh/ssh_host_*</div><div class="line">dpkg-reconfigure openssh-server</div></pre></td></tr></table></figure></p>
<p>然后再重启 ssh 服务即可。</p>
<h2 id="创建防火墙"><a href="#创建防火墙" class="headerlink" title="创建防火墙"></a>创建防火墙</h2><p>查看默认防火墙规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -L</div></pre></td></tr></table></figure></p>
<p>如果出现如下提示，则代表还没有配置过任何防火墙规则。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div></pre></td></tr></table></figure></p>
<p>创建规则配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/iptables.firewall.rules</div></pre></td></tr></table></figure></p>
<p>这里提供一个基础配置，可复制粘帖进去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">*filter</div><div class="line"></div><div class="line">#  Allow all loopback (lo0) traffic and drop all traffic to 127/8 that doesn&apos;t use lo0</div><div class="line">-A INPUT -i lo -j ACCEPT</div><div class="line">-A INPUT -d 127.0.0.0/8 -j REJECT</div><div class="line"></div><div class="line">#  Accept all established inbound connections</div><div class="line">-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</div><div class="line"></div><div class="line">#  Allow all outbound traffic - you can modify this to only allow certain traffic</div><div class="line">-A OUTPUT -j ACCEPT</div><div class="line"></div><div class="line">#  Allow HTTP and HTTPS connections from anywhere (the normal ports for websites and SSL).</div><div class="line">-A INPUT -p tcp --dport 80 -j ACCEPT</div><div class="line">-A INPUT -p tcp --dport 443 -j ACCEPT</div><div class="line"></div><div class="line">#  Allow SSH connections</div><div class="line">#</div><div class="line">#  The -dport number should be the same port number you set in sshd_config</div><div class="line">#</div><div class="line">-A INPUT -p tcp -m state --state NEW --dport 1688 -j ACCEPT</div><div class="line"></div><div class="line">#  Allow ping</div><div class="line">-A INPUT -p icmp --icmp-type echo-request -j ACCEPT</div><div class="line"></div><div class="line">#  Log iptables denied calls</div><div class="line">-A INPUT -m limit --limit 5/min -j LOG --log-prefix &quot;iptables denied: &quot; --log-level 7</div><div class="line"></div><div class="line">#  Drop all other inbound - default deny unless explicitly allowed policy</div><div class="line">-A INPUT -j DROP</div><div class="line">-A FORWARD -j DROP</div><div class="line"></div><div class="line">COMMIT</div></pre></td></tr></table></figure>
<p><code>:wq</code>保存退出。</p>
<p>这个基础配置目前只允许了如下服务和端口：HTTP(80),HTTPS(443),SSH(1688) 和 ping 。</p>
<p>启用规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables-restore &lt; /etc/iptables.firewall.rules</div></pre></td></tr></table></figure></p>
<p>检查是否启用成功：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo iptables -L</div></pre></td></tr></table></figure></p>
<p>新规则如果设置成功会出现如下输出提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line">ACCEPT     all  --  anywhere             anywhere            </div><div class="line">REJECT     all  --  anywhere             loopback/8           reject-with icmp-port-unreachable</div><div class="line">ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED</div><div class="line">ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http</div><div class="line">ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https</div><div class="line">ACCEPT     tcp  --  anywhere             anywhere             state NEW tcp dpt:1688</div><div class="line">ACCEPT     icmp --  anywhere             anywhere             icmp echo-request</div><div class="line">LOG        all  --  anywhere             anywhere             limit: avg 5/min burst 5 LOG level debug prefix &quot;iptables denied: &quot;</div><div class="line">DROP       all  --  anywhere             anywhere            </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line">DROP       all  --  anywhere             anywhere            </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line">ACCEPT     all  --  anywhere             anywhere</div></pre></td></tr></table></figure>
<p>创建脚本使其随机启动：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/network/<span class="keyword">if</span>-pre-up.d/firewall</div></pre></td></tr></table></figure></p>
<p>粘帖如下内容到打开的界面：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">/sbin/iptables-restore &lt; /etc/iptables.firewall.rules</div></pre></td></tr></table></figure></p>
<p>保存并退出。</p>
<p>赋予脚本可执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chmod +x /etc/network/<span class="keyword">if</span>-pre-up.d/firewall</div></pre></td></tr></table></figure></p>
<p>至此防火墙规则配置开始生效并运作。</p>
<h2 id="安装配置-Fail2Ban"><a href="#安装配置-Fail2Ban" class="headerlink" title="安装配置 Fail2Ban"></a>安装配置 Fail2Ban</h2><p>安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install fail2ban</div></pre></td></tr></table></figure></p>
<p>复制并创建个人配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</div></pre></td></tr></table></figure></p>
<p>通过<code>jail.local</code>文件修改配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vi /etc/fail2ban/jail.local</div></pre></td></tr></table></figure></p>
<p>修改配置文件里的 ssh 端口为自己设置的端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[ssh]</div><div class="line"></div><div class="line">enabled  = true</div><div class="line">port     = 1688</div><div class="line">filter   = sshd</div><div class="line">logpath  = /var/log/auth.log</div><div class="line">maxretry = 6</div></pre></td></tr></table></figure></p>
<p>其他的按需配置。</p>
<p>重启 Fail2Ban 使配置生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service fail2ban restart</div></pre></td></tr></table></figure>
<p>可以通过<code>sudo iptables -L</code>命令查看 Fail2Ban 的某些规则是否添加进去了。</p>
<p>至此，关于 VPS 的安全配置暂且告一段落。</p>
<blockquote>
<p>参考资料：</p>
<p><a href="https://www.linode.com/docs/security/securing-your-server" target="_blank" rel="external">Securing-your-server</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-securing-your-linux-vps" target="_blank" rel="external">An-Introduction-to-Securing-your-Linux-VPS</a></p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/how-to-install-dictionaries-for-goldendict/" class="prev">PREV</a><a href="/extensions-for-my-firefox/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ileyar';
var disqus_identifier = 'securing-your-server/';
var disqus_title = 'VPS 安全设置';
var disqus_url = 'http://www.leyar.me/securing-your-server/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ileyar.disqus.com/count.js" async></script><div class="copyright"><p>© 2011 - 2018 <a href="http://www.leyar.me">Leyar</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-74627504-2",'auto');ga('send','pageview');</script></body></html>