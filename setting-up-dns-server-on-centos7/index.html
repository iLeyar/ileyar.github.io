<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CentOS7 上使用 pdnsd 搭建 DNS 服务器 · Leyar's Notebook</title><meta name="description" content="CentOS7 上使用 pdnsd 搭建 DNS 服务器 - Leyar"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.leyar.me/atom.xml" title="Leyar's Notebook"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/iLeyar" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">CentOS7 上使用 pdnsd 搭建 DNS 服务器</h1><div class="post-info">2015年7月30日</div><div class="post-content"><p>最近在折腾路由器（后续再把自己的步骤记录一下）其中涉及到防 DNS 污染的问<br>题，优化方案我选择了在自己的 VPS 上搭建 DNS 服务器。这里记录下我的搭建过<br>程。</p>
<p>系统： CentOS 7 64bit</p>
<h2 id="安装-pdnsd"><a href="#安装-pdnsd" class="headerlink" title="安装 pdnsd"></a>安装 pdnsd</h2><p>到官方<a href="http://members.home.nl/p.a.rombouts/pdnsd/dl.html" target="_blank" rel="external">pdnsd Download Page</a>下载最新版本 rpm 包，截至今日（2015-7-30）最新版本为 1.2.9：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://members.home.nl/p.a.rombouts/pdnsd/releases/pdnsd-1.2.9a-par_sl6.x86_64.rpm</div></pre></td></tr></table></figure></p>
<p>然后通过 yum 安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum localinstall pdnsd-1.2.9a-par_sl6.x86_64.rpm</div></pre></td></tr></table></figure></p>
<p>如此安装完成。<br><a id="more"></a></p>
<h2 id="配置-pdnsd"><a href="#配置-pdnsd" class="headerlink" title="配置 pdnsd"></a>配置 pdnsd</h2><p>拷贝配置样本 <code>/etc/pdnsd.conf.sample</code>，并重命名为<code>/etc/pdnsd.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp /etc/pdnsd.conf.sample /etc/pdnsd.conf</div></pre></td></tr></table></figure>
<p>编辑配置文件 <code>pdnsd.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/pdnsd.conf</div></pre></td></tr></table></figure>
<p>参考我的配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">// Sample pdnsd configuration file. Must be customized to obtain a working pdnsd setup!</div><div class="line">// Read the pdnsd.conf(5) manpage for an explanation of the options.</div><div class="line">// Add or remove &apos;#&apos; in front of options you want to disable or enable, respectively.</div><div class="line">// Remove &apos;/*&apos; and &apos;*/&apos; to enable complete sections.</div><div class="line"></div><div class="line">global &#123;</div><div class="line">	perm_cache=4096;</div><div class="line">	cache_dir=&quot;/var/cache/pdnsd&quot;;</div><div class="line">#	pid_file = /var/run/pdnsd.pid;</div><div class="line">	run_as=&quot;pdnsd&quot;;</div><div class="line">	server_ip = 0.0.0.0;  # Use eth0 here if you want to allow other</div><div class="line">				# machines on your network to query pdnsd.</div><div class="line">	server_port = 9909;</div><div class="line">	status_ctl = on;</div><div class="line">#	paranoid=on;       # This option reduces the chance of cache poisoning</div><div class="line">	                   # but may make pdnsd less efficient, unfortunately.</div><div class="line">	query_method=udp_tcp;</div><div class="line">	min_ttl=1d;       # Retain cached entries at least 15 minutes.</div><div class="line">	max_ttl=1w;        # One week.</div><div class="line">	timeout=5;        # Global timeout option (10 seconds).</div><div class="line">	neg_domain_pol=on;</div><div class="line">	udpbufsize=1024;   # Upper limit on the size of UDP messages.</div><div class="line">&#125;</div><div class="line"></div><div class="line"># The following section is most appropriate if you have a fixed connection to</div><div class="line"># the Internet and an ISP which provides good DNS servers.</div><div class="line">server &#123;</div><div class="line">	label= &quot;googledns&quot;;</div><div class="line">	ip = 8.8.8.8</div><div class="line">	, 8.8.4.4</div><div class="line">	;		   # Put your ISP&apos;s DNS-server address(es) here.</div><div class="line">#	proxy_only=on;     # Do not query any name servers beside your ISP&apos;s.</div><div class="line">	                   # This may be necessary if you are behind some</div><div class="line">	                   # kind of firewall and cannot receive replies</div><div class="line">	                   # from outside name servers.</div><div class="line">	timeout=3;         # Server timeout; this may be much shorter</div><div class="line">			   # that the global timeout option.</div><div class="line">	uptest=none;       # Test if the network interface is active.</div><div class="line">	interface=eth0;    # The name of the interface to check.</div><div class="line">	interval=10m;      # Check every 10 minutes.</div><div class="line">	purge_cache=off;   # Keep stale cache entries in case the ISP&apos;s</div><div class="line">			   # DNS servers go offline.</div><div class="line">	edns_query=yes;    # Use EDNS for outgoing queries to allow UDP messages</div><div class="line">			   # larger than 512 bytes. May cause trouble with some</div><div class="line">			   # legacy systems.</div><div class="line">#	exclude=.localdomain;  # If your ISP censors certain names, you may</div><div class="line">#			   # want to exclude them here, and provide an</div><div class="line">#			    # alternative server section below that will</div><div class="line">#			    # successfully resolve the names.</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line"># The following section is more appropriate for dial-up connections.</div><div class="line"># Read about how to use pdnsd-ctl for dynamic configuration in the documentation.</div><div class="line">server &#123;</div><div class="line">	label= &quot;dialup&quot;;</div><div class="line">	file = &quot;/etc/ppp/resolv.conf&quot;;  # Preferably do not use /etc/resolv.conf</div><div class="line">	proxy_only=on;</div><div class="line">	timeout=4;</div><div class="line">	uptest=if;</div><div class="line">	interface = ppp0;</div><div class="line">	interval=10;       # Check the interface every 10 seconds.</div><div class="line">	purge_cache=off;</div><div class="line">	preset=off;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"></div><div class="line">/*</div><div class="line"># The servers provided by OpenDNS are fast, but they do not reply with</div><div class="line"># NXDOMAIN for non-existant domains, instead they supply you with an</div><div class="line"># address of one of their search engines. They also lie about the addresses of </div><div class="line"># of the search engines of google, microsoft and yahoo.</div><div class="line"># If you do not like this behaviour the &quot;reject&quot; option may be useful.</div><div class="line">server &#123;</div><div class="line">	label = &quot;opendns&quot;;</div><div class="line">	ip = 208.67.222.222, 208.67.220.220;</div><div class="line">	reject = 208.69.32.0/24,  # You may need to add additional address ranges</div><div class="line">	         208.69.34.0/24,  # here if the addresses of their search engines</div><div class="line">	         208.67.219.0/24; # change.</div><div class="line">	reject_policy = fail;     # If you do not provide any alternative server</div><div class="line">	                          # sections, like the following root-server</div><div class="line">	                          # example, &quot;negate&quot; may be more appropriate here.</div><div class="line">	timeout = 4;</div><div class="line">	uptest = ping;            # Test availability using ICMP echo requests.</div><div class="line">        ping_timeout = 100;       # ping test will time out after 10 seconds.</div><div class="line">	interval = 15m;           # Test every 15 minutes.</div><div class="line">	preset = off;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"></div><div class="line">/*</div><div class="line"># This section is meant for resolving from root servers.</div><div class="line">server &#123;</div><div class="line">	label = &quot;root-servers&quot;;</div><div class="line">	root_server = discover; # Query the name servers listed below</div><div class="line">				# to obtain a full list of root servers.</div><div class="line">	randomize_servers = on; # Give every root server an equal chance</div><div class="line">	                        # of being queried.</div><div class="line">	ip = 	198.41.0.4,     # This list will be expanded to the full</div><div class="line">		192.228.79.201; # list on start up.</div><div class="line">	timeout = 5;</div><div class="line">	uptest = query;         # Test availability using empty DNS queries.</div><div class="line">#	query_test_name = .;    # To be used if remote servers ignore empty queries.</div><div class="line">	interval = 30m;         # Test every half hour.</div><div class="line">	ping_timeout = 300;     # Test should time out after 30 seconds.</div><div class="line">	purge_cache = off;</div><div class="line">#	edns_query = yes;	# Use EDNS for outgoing queries to allow UDP messages</div><div class="line">			   	# larger than 512 bytes. May cause trouble with some</div><div class="line">			   	# legacy systems.</div><div class="line">	exclude = .localdomain;</div><div class="line">	policy = included;</div><div class="line">	preset = off;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"></div><div class="line">source &#123;</div><div class="line">	owner=localhost;</div><div class="line">#	serve_aliases=on;</div><div class="line">	file=&quot;/etc/hosts&quot;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line">include &#123;file=&quot;/etc/pdnsd.include&quot;;&#125;	# Read additional definitions from /etc/pdnsd.include.</div><div class="line">*/</div><div class="line"></div><div class="line">rr &#123;</div><div class="line">	name=localhost;</div><div class="line">	reverse=on;</div><div class="line">	a=127.0.0.1;</div><div class="line">	owner=localhost;</div><div class="line">	soa=localhost,root.localhost,42,86400,900,86400,86400;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line">neg &#123;</div><div class="line">	name=doubleclick.net;</div><div class="line">	types=domain;   # This will also block xxx.doubleclick.net, etc.</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"></div><div class="line">/*</div><div class="line">neg &#123;</div><div class="line">	name=bad.server.com;   # Badly behaved server you don&apos;t want to connect to.</div><div class="line">	types=A,AAAA;</div><div class="line">&#125;</div><div class="line">*/</div></pre></td></tr></table></figure></p>
<p>更多配置详情参考：<a href="http://members.home.nl/p.a.rombouts/pdnsd/doc.html" target="_blank" rel="external">pdnsd Documents</a></p>
<h2 id="启动-pdnsd"><a href="#启动-pdnsd" class="headerlink" title="启动 pdnsd"></a>启动 pdnsd</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service pdnsd start</div></pre></td></tr></table></figure>
<p>开机启动：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkcongif pdnsd on</div></pre></td></tr></table></figure></p>
<h2 id="添加防火墙规则"><a href="#添加防火墙规则" class="headerlink" title="添加防火墙规则"></a>添加防火墙规则</h2><p>将 pdnsd 端口（我的是 9909）加入防火墙规则列表里：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/sbin/iptables <span class="_">-l</span> INPUT -p tcp --dport 9909 -j ACCEPT</div><div class="line">/etc/init.d/iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure></p>
<h2 id="测试-pdnsd"><a href="#测试-pdnsd" class="headerlink" title="测试 pdnsd"></a>测试 pdnsd</h2><p>本地使用自建 DNS 测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dig @x.x.x.x -p 9909 youtube.com	<span class="comment"># x.x.x.x 改为 DNS 服务器 IP</span></div></pre></td></tr></table></figure></p>
<p>如果设置正确，则会出现如下查询结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">; &lt;&lt;&gt;&gt; DiG 9.10.2-P2 &lt;&lt;&gt;&gt; @104.131.144.145 -p 9909 youtube.com</div><div class="line">; (1 server found)</div><div class="line">;; global options: +cmd</div><div class="line">;; Got answer:</div><div class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 11382</div><div class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 11, AUTHORITY: 0, ADDITIONAL: 1</div><div class="line"></div><div class="line">;; OPT PSEUDOSECTION:</div><div class="line">; EDNS: version: 0, flags:; udp: 1024</div><div class="line">;; QUESTION SECTION:</div><div class="line">;youtube.com.			IN	A</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">youtube.com.		82182	IN	A	74.125.239.98</div><div class="line">youtube.com.		82182	IN	A	74.125.239.96</div><div class="line">youtube.com.		82182	IN	A	74.125.239.102</div><div class="line">youtube.com.		82182	IN	A	74.125.239.97</div><div class="line">youtube.com.		82182	IN	A	74.125.239.105</div><div class="line">youtube.com.		82182	IN	A	74.125.239.100</div><div class="line">youtube.com.		82182	IN	A	74.125.239.110</div><div class="line">youtube.com.		82182	IN	A	74.125.239.99</div><div class="line">youtube.com.		82182	IN	A	74.125.239.104</div><div class="line">youtube.com.		82182	IN	A	74.125.239.103</div><div class="line">youtube.com.		82182	IN	A	74.125.239.101</div><div class="line"></div><div class="line">;; Query time: 190 msec</div><div class="line">;; SERVER: 104.131.144.145#9909(104.131.144.145)</div><div class="line">;; WHEN: Thu Jul 30 01:50:40 CST 2015</div><div class="line">;; MSG SIZE  rcvd: 216</div></pre></td></tr></table></figure></p>
<p>返回的 ip 可参考：<a href="https://www.whatsmydns.net" target="_blank" rel="external">Whatsmydns</a></p>
<p>参考来源：<a href="http://blog.tshine.me/centos%E8%87%AA%E5%BB%BAdns%E6%9C%8D%E5%8A%A1%E5%99%A8.html" target="_blank" rel="external">Centos自建DNS</a> </p>
</div></article></div></main><footer><div class="paginator"><a href="/netgear-wndr4300-openwrt-shadowsocks/" class="prev">上一篇</a><a href="/installation-of-archlinux/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ileyar';
var disqus_identifier = 'setting-up-dns-server-on-centos7/';
var disqus_title = 'CentOS7 上使用 pdnsd 搭建 DNS 服务器';
var disqus_url = 'http://www.leyar.me/setting-up-dns-server-on-centos7/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ileyar.disqus.com/count.js" async></script><div class="copyright"><p>© 2011 - 2018 <a href="http://www.leyar.me">Leyar</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-74627504-2",'auto');ga('send','pageview');</script></body></html>